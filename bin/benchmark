#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
  gem "debug"
  gem "dry-equalizer"
  gem "equatable"
  gem "wholeable", path: ".."
end

NAME = "demo"
LABEL = "Demo"
DESCRIPTION = "A demonstration."

DataDemo = Data.define :name, :label, :description

class Equal
  include Dry::Equalizer(:name, :label, :description)

  attr_reader :name, :label, :description

  def initialize name: NAME, label: LABEL, description: DESCRIPTION
    @name = name
    @label = label
    @description = description
  end
end

class Equat
  include Equatable

  attr_reader :name, :label, :description

  def initialize name: NAME, label: LABEL, description: DESCRIPTION
    @name = name
    @label = label
    @description = description
  end
end

StructDemo = Struct.new :name, :label, :description

class Whole
  include Wholeable[:name, :label, :description]

  def initialize name: NAME, label: LABEL, description: DESCRIPTION
    @name = name
    @label = label
    @description = description
  end
end

object = Object.new
data = DataDemo[name: NAME, label: LABEL, description: DESCRIPTION]
equal = Equal.new
equat = Equat.new
struct = StructDemo[name: NAME, label: LABEL, description: DESCRIPTION]
whole = Whole.new

puts "\nINITIALIZATION\n\n"

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Data") { DataDemo[name: NAME, label: LABEL, description: DESCRIPTION] }
  benchmark.report("Equalizer") { Equal.new }
  benchmark.report("Equatable") { Equat.new }
  benchmark.report("Struct") { StructDemo[name: NAME, label: LABEL, description: DESCRIPTION] }
  benchmark.report("Wholeable") { Whole.new }

  benchmark.compare!
end

puts "MESSAGING\n\n"

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report "Data" do
    data.name
    data.label
    data.description
    data.hash
    data.inspect
    data == object
    data.eql? object
  end

  benchmark.report "Equalizer" do
    equal.name
    equal.label
    equal.description
    equal.hash
    equal.inspect
    equal == object
    equal.eql? object
  end

  benchmark.report "Equatable" do
    equat.name
    equat.label
    equat.description
    equat.hash
    equat.inspect
    equat == object
    equat.eql? object
  end

  benchmark.report "Struct" do
    struct.name
    struct.label
    struct.description
    struct.hash
    struct.inspect
    struct == object
    struct.eql? object
  end

  benchmark.report "Wholeable" do
    whole.name
    whole.label
    whole.description
    whole.hash
    whole.inspect
    whole == object
    whole.eql? object
  end

  benchmark.compare!
end

__END__

INITIALIZATION

ruby 4.0.1 (2026-01-13 revision e04267a14b) +YJIT +PRISM [arm64-darwin25.2.0]
Warming up --------------------------------------
                Data   411.580k i/100ms
           Equalizer     2.225M i/100ms
           Equatable     2.321M i/100ms
              Struct   455.823k i/100ms
           Wholeable   859.120k i/100ms
Calculating -------------------------------------
                Data      4.903M (± 8.8%) i/s  (203.94 ns/i) -     24.695M in   5.072786s
           Equalizer     25.434M (± 8.5%) i/s   (39.32 ns/i) -    126.805M in   5.018058s
           Equatable     25.399M (± 7.9%) i/s   (39.37 ns/i) -    127.656M in   5.053633s
              Struct      4.811M (± 7.7%) i/s  (207.85 ns/i) -     24.159M in   5.048700s
           Wholeable     10.649M (± 8.9%) i/s   (93.91 ns/i) -     53.265M in   5.044738s

Comparison:
           Equalizer: 25434240.3 i/s
           Equatable: 25398808.9 i/s - same-ish: difference falls within error
           Wholeable: 10648737.2 i/s - 2.39x  slower
                Data:  4903352.0 i/s - 5.19x  slower
              Struct:  4811046.3 i/s - 5.29x  slower

MESSAGING

ruby 4.0.1 (2026-01-13 revision e04267a14b) +YJIT +PRISM [arm64-darwin25.2.0]
Warming up --------------------------------------
                Data   125.714k i/100ms
           Equalizer    97.991k i/100ms
           Equatable    94.801k i/100ms
              Struct   121.077k i/100ms
           Wholeable    96.806k i/100ms
Calculating -------------------------------------
                Data      1.368M (±12.1%) i/s  (731.11 ns/i) -      6.789M in   5.052046s
           Equalizer    997.443k (±11.4%) i/s    (1.00 μs/i) -      4.998M in   5.074622s
           Equatable    996.404k (± 9.6%) i/s    (1.00 μs/i) -      5.024M in   5.087767s
              Struct      1.429M (±10.0%) i/s  (699.99 ns/i) -      7.144M in   5.051871s
           Wholeable    967.377k (±10.7%) i/s    (1.03 μs/i) -      4.840M in   5.060414s

Comparison:
              Struct:  1428586.9 i/s
                Data:  1367792.5 i/s - same-ish: difference falls within error
           Equalizer:   997443.1 i/s - 1.43x  slower
           Equatable:   996404.3 i/s - 1.43x  slower
           Wholeable:   967377.2 i/s - 1.48x  slower
